# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cxx11 1.1

set base_package        lilypond
name                    ${base_package}-devel
version                 2.19.84
set branch              [join [lrange [split ${version} .] 0 1] .]
revision                0

categories              textproc
maintainers             {snc @nerdling} \
                        {@jahrme jahrme.com:github} \
                        openmaintainer
license                 GPL-3+
description             An automated engraving system for typesetting sheet music.
long_description        Lilypond is a unix-based automated engraving system    \
                        that generates beautiful sheet music from input files. \
                        Lilypond uses its own input format, .ly, which in many \
                        ways is similar to LaTeX. Lilypond can export sheet    \
                        music to PDF, EPS, SVG, and PNG formats, and can also  \
                        create MIDI files.

homepage                http://lilypond.org/
conflicts               ${base_package}
platforms               darwin
master_sites            http://lilypond.org/download/sources/v${branch}/
distname                ${base_package}-${version}
checksums               rmd160  3e670a96d4394e00cf0d8a32aa003344beed9702 \
                        sha256  94dcc66447f24966f28eda72c79e1ec16143b8ea4a537cc9f97d017cc0c0dd11 \
                        size    18050320
universal_variant       no

depends_build           port:autoconf \
                        port:bison \
                        port:dblatex \
                        port:flex \
                        port:fontforge \
                        port:gmake \
                        port:netpbm \
                        port:p5.28-encode \
                        port:p5.28-pod-escapes \
                        port:p5.28-pod-simple \
                        port:p5.28-podlators \
                        port:p5.28-scalar-list-utils \
                        port:pango \
                        port:pkgconfig \
                        port:rsync \
                        port:t1utils \
                        port:texi2html \
                        port:texinfo \
                        port:texlive-fonts-recommended \
                        port:texlive-lang-cyrillic \
                        port:texlive-metapost \
                        port:texlive-xetex \
                        port:urw-core35-fonts

depends_lib             port:extractpdfmark \
                        port:ghostscript \
                        port:guile18 \
                        port:python27

build.type              gnu

configure.env-append    GUILE=${prefix}/bin/guile18
configure.env-append    GUILE_CONFIG=${prefix}/bin/guile18-config
configure.env-append    GUILE_TOOLS=${prefix}/bin/guile18-tools

configure.env-append    LTDL_LIBRARY_PATH=${prefix}/lib
build.env-append        LTDL_LIBRARY_PATH=${prefix}/lib
destroot.env-append     LTDL_LIBRARY_PATH=${prefix}/lib

configure.cmd           autoconf -f && ./configure

configure.args-append   --disable-documentation
configure.args-append   --with-texgyre-dir=${prefix}/share/texmf-texlive/fonts/opentype/public/tex-gyre
configure.args-append   --with-urwotf-dir=${prefix}/share/fonts/urw-core35-fonts

post-patch {
    # Use guile18 header files.
    reinplace \
        s|libguile\.h|libguile18.h|g \
        ${worksrcpath}/aclocal.m4 \
        ${worksrcpath}/configure.ac \
        ${worksrcpath}/lily/include/lily-guile.hh
    # Correct mf2pt1 binary location.
    reinplace \
        s|"-mem=mf2pt1"|"-mem=../../mf2pt1"|g \
        ${worksrcpath}/scripts/build/mf2pt1.pl
}

post-destroot {
    move \
        ${destroot}${prefix}/bin/lilypond \
        ${destroot}${prefix}/libexec/lilypond-bin
    xinstall -m 755 \
        ${filespath}/lilypond.in \
        ${destroot}${prefix}/bin/lilypond
    reinplace \
        "s|@@PREFIX@@|${prefix}|g" \
        ${destroot}${prefix}/bin/lilypond
}

livecheck.type          regex
livecheck.url           ${homepage}/development.html
livecheck.regex         ${base_package}-(\\d+(\\.\\d+)+)
